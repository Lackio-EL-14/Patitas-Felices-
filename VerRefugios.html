<!DOCTYPE html>
<html lang="es">

<body>
  <title>Refugios</title>
  <link rel="stylesheet" href="styles.css">
</body>
<nav class="navbar">
  <div class="logo">
    <img src="imagenes/logo.jpeg" alt="logo Patitas Felices" class="logo-img" />
  </div>

  <div class="nav-links">
    <a href="panel-solicitudes-adopcion.html" class="nav-item">Solicitudes</a>
    <a href="seguimiento-mascota.html" class="nav-item">Seguimiento</a>
    <a href="VerAdopciones.html" class="nav-item">Adopciones</a>
    <a href="VerRefugios.html" class="nav-item">Refugios</a>

    <a href="./lost-dogs.html" class="nav-item active">Extraviados</a>
  </div>

</nav>
<h1>Todos los Refugios</h1>

<div style="margin: 20px 0;">
  <label for="filtro-nombre">Buscar por nombre:</label>
  <input 
    type="text" 
    id="filtro-nombre" 
    data-testid="input-nombre"
    placeholder="Ejemplo: Huellitas"
  />
  <label for="filtro-departamento" style="margin-left: 20px;">Departamento:</label>
  <select 
    id="filtro-departamento" 
    data-testid="select-departamento"
  >
    <option value="Todos">Todos</option>
  </select>
<label for="filtro-capacidad" style="margin-left: 20px;">Capacidad m√≠nima:</label>
  <input 
    type="number" 
    id="filtro-capacidad" 
    data-testid="input-capacidad-min"
    placeholder="Ej: 3"
    min="0"
  />
</div>

<div id="lista-refugios"></div>

<script type="module">
  import RefugioRepository from './src/Ejemplos base/Infraestructure/RefugioRepository.js';
  import buscarRefugiosService from './src/Ejemplos base/Services/buscarRefugiosService.js';

  const repository = new RefugioRepository();
  const service = buscarRefugiosService(repository);
  let refugioExpandido = null;

  function mostrarRefugios(refugios) {
    const listaRefugios = document.getElementById('lista-refugios');
    listaRefugios.innerHTML = '';
    
    refugios.forEach(refugio => {
      const refugioDiv = document.createElement('div');
      refugioDiv.setAttribute('data-testid', 'refugio-item');
      refugioDiv.style.border = '1px solid #ccc';
      refugioDiv.style.padding = '15px';
      refugioDiv.style.marginBottom = '10px';
      refugioDiv.style.borderRadius = '5px';
      
      refugioDiv.innerHTML = `
        <h3>${refugio.nombre}</h3>
        <p>Departamento: ${refugio.departamento}</p>
        <p>Mascotas: ${refugio.capacidad}</p>
        <button data-testid="btn-ver-mascotas" data-refugio-id="${refugio.id}">Ver mascotas</button>
        <div id="mascotas-${refugio.id}" style="display: none; margin-top: 10px;"></div>
      `;
      
      listaRefugios.appendChild(refugioDiv);
    });
    
    document.querySelectorAll('[data-testid="btn-ver-mascotas"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const refugioId = parseInt(e.target.getAttribute('data-refugio-id'));
        toggleMascotas(refugioId, e.target);
      });
    });
  }

  function toggleMascotas(refugioId, boton) {
    const mascotasDiv = document.getElementById(`mascotas-${refugioId}`);
    
    if (refugioExpandido === refugioId) {
      mascotasDiv.style.display = 'none';
      mascotasDiv.innerHTML = '';
      mascotasDiv.removeAttribute('data-testid');
      boton.textContent = 'Ver mascotas';
      refugioExpandido = null;
    } else {
      if (refugioExpandido !== null) {
        const prevDiv = document.getElementById(`mascotas-${refugioExpandido}`);
        if (prevDiv) {
          prevDiv.style.display = 'none';
          prevDiv.innerHTML = '';
          prevDiv.removeAttribute('data-testid');
          const prevBtn = document.querySelector(`[data-refugio-id="${refugioExpandido}"]`);
          if (prevBtn) prevBtn.textContent = 'Ver mascotas';
        }
      }
      
      const mascotas = service.obtenerMascotasDeRefugio(refugioId);
      mascotasDiv.setAttribute('data-testid', 'lista-mascotas');
      mascotasDiv.innerHTML = '<h4>Mascotas disponibles:</h4>';
      
      const mascotasUl = document.createElement('ul');
      mascotas.forEach(mascota => {
        const li = document.createElement('li');
        li.setAttribute('data-testid', 'mascota-nombre');
        li.textContent = mascota;
        mascotasUl.appendChild(li);
      });
      
      mascotasDiv.appendChild(mascotasUl);
      mascotasDiv.style.display = 'block';
      boton.textContent = 'Ocultar mascotas';
      refugioExpandido = refugioId;
    }
  }

  function aplicarFiltros() {
    const nombre = inputNombre.value;
    const departamento = selectDepartamento.value;
    const capacidadMinima = inputCapacidad.value ? parseInt(inputCapacidad.value) : null;
    
    const refugiosFiltrados = service.filtrarRefugiosCompleto(nombre, departamento, capacidadMinima);
    mostrarRefugios(refugiosFiltrados);
  }


  const selectDepartamento = document.getElementById('filtro-departamento');
  const departamentos = repository.obtenerDepartamentos();
  departamentos.forEach(depto => {
    const option = document.createElement('option');
    option.value = depto;
    option.textContent = depto;
    selectDepartamento.appendChild(option);
  });

 
  mostrarRefugios(service.obtenerTodosLosRefugios());


  const inputNombre = document.getElementById('filtro-nombre');
  const inputCapacidad = document.getElementById('filtro-capacidad');
  
  inputNombre.addEventListener('input', aplicarFiltros);
  selectDepartamento.addEventListener('change', aplicarFiltros);
  inputCapacidad.addEventListener('input', aplicarFiltros);
</script>

</html>